<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajouter à Google Calendar</title>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <button id="authorize-button">Autoriser</button>
    <button id="add-calendar-button" style="display:none;">Ajouter à Google Calendar</button>

    <script>
        // Identifiants OAuth 2.0 (à remplacer par les vôtres)
        const CLIENT_ID = '412760379329-45opd9rn1kq3nugv8kn6sbpsdirssal2.apps.googleusercontent.com';
        const API_KEY = ${{ secrets.API_KEY }};
        const SCOPES = "https://www.googleapis.com/auth/calendar";

        // URL de l'agenda à ajouter
        const CALENDAR_URL = "https://ade-uga-ro-vs.grenet.fr/jsp/custom/modules/plannings/anonymous_cal.jsp?resources=32185&projectId=3&calType=ical&firstDate=2024-08-05&lastDate=2025-08-01";

        function handleClientLoad() {
            gapi.load('client:auth2', initClient);
        }

        function initClient() {
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
                scope: SCOPES
            }).then(() => {
                const authorizeButton = document.getElementById('authorize-button');
                const addCalendarButton = document.getElementById('add-calendar-button');

                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());

                authorizeButton.onclick = handleAuthClick;
                addCalendarButton.onclick = addCalendar;
            });
        }

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                document.getElementById('authorize-button').style.display = 'none';
                document.getElementById('add-calendar-button').style.display = 'block';
            } else {
                document.getElementById('authorize-button').style.display = 'block';
                document.getElementById('add-calendar-button').style.display = 'none';
            }
        }

        function handleAuthClick() {
            gapi.auth2.getAuthInstance().signIn();
        }

        function addCalendar() {
            gapi.client.calendar.calendarList.insert({
                resource: {
                    id: CALENDAR_URL,
                    summary: 'Mon Agenda',
                    description: 'Agenda ajouté via l\'API',
                    timeZone: 'Europe/Paris'
                }
            }).then(response => {
                alert("Agenda ajouté avec succès!");
            }).catch(error => {
                console.error("Erreur lors de l'ajout de l'agenda: ", error);
                alert("Erreur lors de l'ajout de l'agenda.");
            });
        }

        handleClientLoad();
    </script>
</body>
</html>
